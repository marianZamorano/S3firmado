name: 4. Subida a S3 con URL Prefirmada

on:
  # Permite ejecutar el workflow manualmente (ideal para pruebas)
  workflow_dispatch:

env:
  # Tu bucket (del paso anterior)
  BUCKET_NAME: m-s3-firmado
  # La regiÃ³n (de tus Secrets)
  AWS_REGION: ${{ secrets.AWS_REGION }}
  # Nombre del archivo que *existe* en el runner y serÃ¡ subido
  FILE_TO_UPLOAD: archivo-subido-${{ github.sha }}.png 
  # Path final en S3 (usamos el hash de Git para hacerlo Ãºnico)
  S3_KEY_PATH: builds/imagenes/${{ env.FILE_TO_UPLOAD }} 

jobs:
  upload:
    # Usamos ubuntu para tener curl y AWS CLI
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      # PASO DE PREPARACIÃ“N: 
      # âš ï¸ Reemplaza esto con el paso real donde se genera/descarga tu archivo
      - name: ðŸ“ Crear un archivo de prueba
        run: |
          echo "Este es el contenido de un archivo PNG/Video/etc." > ${{ env.FILE_TO_UPLOAD }}
          echo "Simulando la existencia de la imagen/video a subir..."
        shell: bash

      - name: ðŸ” Configurar Credenciales de AWS
        # Esta acciÃ³n utiliza los Secrets que configuraste
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”— Generar URL Prefirmada (PUT)
        id: presign_url
        run: |
          # 1. Definimos el MIME Type. S3 lo requiere en la subida.
          # Debes ajustar esto para que coincida con el tipo de archivo real (image/png, video/mp4, etc.)
          MIME_TYPE="image/png"
          
          # 2. Generamos la URL prefirmada con AWS CLI
          # --expires-in 600 son 10 minutos de validez
          PRESIGNED_URL=$(aws s3 presign s3://${{ env.BUCKET_NAME }}/${{ env.S3_KEY_PATH }} \
                          --region ${{ env.AWS_REGION }} \
                          --expires-in 600 \
                          --only-show-errors)
          
          # 3. Exportamos la URL y el MIME Type para el siguiente paso
          echo "PRESIGNED_URL=$PRESIGNED_URL" >> $GITHUB_OUTPUT
          echo "MIME_TYPE=$MIME_TYPE" >> $GITHUB_OUTPUT
        shell: bash

      - name: ðŸ“¤ Subir archivo a S3 usando la URL Prefirmada
        # Obtiene las salidas del paso anterior
        env:
          URL: ${{ steps.presign_url.outputs.PRESIGNED_URL }}
          MIME: ${{ steps.presign_url.outputs.MIME_TYPE }}
        run: |
          echo "Iniciando subida con cURL..."
          
          # Usamos cURL para ejecutar el PUT HTTP contra la URL firmada.
          curl -v -X PUT -T "${{ env.FILE_TO_UPLOAD }}" \
               -H "Content-Type: ${MIME}" \
               "${URL}"
               
          echo "Subida completada a la ruta: s3://${{ env.BUCKET_NAME }}/${{ env.S3_KEY_PATH }}"
        shell: bash